---
yititle: 操作系统
header-img: back.png
header-color: 'white'
tag-color: 'rgb(0,0,1)'
catalog: true
toc-number: false
date: 2020-05-13 17:36:27
tags: ['操作系统']

---

## 1. 操作系统概述

### 1.1 基本概念

#### 1.1.1 概念

操作系统是控制和管理整个计算机系统的硬件和软件资源<sup>⑴</sup>，并合理地组织调度计算机的工作和资源的分配<sup>⑵</sup>，以提供给用户和其他软件方便的接口和环境的**程序集合**

#### 1.1.2 特征

- **并发**

  两个或多个事件在同一时间间隔内发生，操作系统的并发性是通过**分时**实现的。

  注意与并行的区别，并行是两个或多个事件在同一时刻发生

- **共享**

  指系统中的资源可供内存中多个并发执行的进程使用。有以下两种方式:

  - **互斥共享方式**

    系统中的某些资源，比如打印机，虽然可以提供给多个进程使用，但为使打印结果不混淆，一段时间内只允许一个进程访问该资源。即串行地访问

    把一段时间内只允许一个进程访问的资源称为**临界资源**或**独占资源**。计算机系统中的大多物理设备，以及某些软件中使用的堆栈都属于临界资源，他们要求被互斥地共享

  - **同时访问方式**

    系统中还有另一类资源，如磁盘设备，允许多个进程并发地访问

- 虚拟

  把一个物理的实体变为若干个逻辑上的对应物

  - **虚拟处理器技术**

    使用多道程序技术，让多道程序并发执行的方法

  - **虚拟存储器技术**

    将一台机器的物理存储器变为虚拟存储器，以便从逻辑上扩充存储器容量

  - **虚拟设备技术**

    将一台物理 I/O 设备虚拟成多台逻辑上的 I/O 设备，把设备变为一段时间内允许多个用户同时访问的共享设备

- 异步

  在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程执行不是一贯到底而是走走停停，以不可预知的速度向前推进，这就是进程的异步性。

#### 1.1.3 目标和功能

- **系统资源的管理者**

  - 处理机管理

    进程控制，进程同步，进程通信，死锁处理，处理机调度

  - 存储器管理

    内存分配，地址映射，内存扩充，内存保护与共享

  - 文件管理

    文件存储空间管理，目录管理，文件读写管理与保护

  - 设备管理

    缓冲管理，设备分配，设备处理，虚拟设备

- **用户与硬件间的接口**

  - 命令接口

    用户利用这些命令组织和控制作业的执行，分为以下两种:

    - 联机命令接口 (交互命令接口)，适用于分时或实时系统的接口
    - 脱机命令接口 (批处理命令接口)，适用于批处理系统

  - 系统调用 (程序接口 广义指令)

    用户在程序中使用系统调用命令请求操作系统为其服务

- **扩充机器**

  没有任何软件支持的计算机成为裸机，操作系统把裸机改造成功能更强使用更方便的机器，称为扩充机器或虚拟机

### 1.2 发展与分类

- 手工操作阶段 (没有操作系统)

- 单道批处理系统

- 多道批处理系统

  相对于单道批处理系统许需要**额外的开销**进行任务调度

- 分时操作系统

- 实时操作系统

  进程调度通常采用 **抢占式的优先级高者优先** 算法

- 网络操作系统和分布式操作系统

- 个人操作系统

### 1.3 操作系统的运行环境

#### 1.3.1 运行机制

CPU 会执行两种不同性质的程序: **操作系统的内核程序** 和 **用户编写的应用程序**。相对应的状态为 **核心态 (管态)** 和 **用户态 (目态)** 在核心态可执行一些 **特权指令**

用户态通过**中断或异常**可以切换到核心态，核心态**处理完中断**返回用户态

操作系统内核一般包括:

- **时钟管理**

  - 计时，向用户提供标准的系统时间
  - 通过**时钟中断**的管理可以实现进程的切换

- **中断机制**

  提高多道程序运行环境中 CPU 的利用率。现代操作系统是靠中断驱动的软件

- **原语**

  可被调用的不可分割的，运行时间短且调用频繁的公共小程序。定义原语最直接的方式是屏蔽中断

- **系统控制的数据结构及处理**

  进程管理、存储器管理、设备管理

#### 1.3.2 中断和异常

中断和异常是通过硬件实现的。

- **中断 (外中断)**

  CPU 执行指令以外的事件产生即与当前程序运行无关的事件所产生的中断。如设备发出的 I/O 结束中断，表示设备输入/输出已完成。

- **异常 (内中断 例外 陷入)**

  CPU 执行指令时产生的异常。如除 0 ，地址越界，缺页等。**无法被屏蔽**

#### 1.3.3 系统调用

系统调用是用户在程序。调用操作系统提供的一些功能。运行在**核心态**。可分为以下几类：

- 设备管理
- 文件管理
- 进程控制
- 进程通信
- 内存管理

### 1.4 大内核和微内核

大内核系统将操作系统的主要功能模块作为一个紧密联系的整体运行在核心态，从而为应用提供高性能的系统服务

微内核系统只将内核中最基本的功能保留在内核，而将不需要在核心态执行的功能移到用户态执行，降低了内核设计复杂性。

微内核的优缺点:

- 不如大内核高效
- 添加系统服务时，不必修改内核
- 因为内核内服务变少，所以系统更可靠

## 2. 进程管理

### 2.1 进程与线程

#### 2.1.1 进程的概念与特征

进程实体由**程序段**、**数据段**、**PCB**构成。进程是进程实体的运行过程，是系统进行资源分配和调度的独立单位。进程是一个**动态的**、**过程性**的概念。

==PCB是进程存在的唯一标志==

**进程的特征**

- **动态性**

  进程最基本的特征。指进程具有一定的生命周期，动态地产生、变化和消亡。

- 并发性

  多个进程实体，可以在一段时间内同时运行

- 独立性

  进程实体是一个能独立运行、独立获得资源和接受调度的基本单位

- 异步性

  进程按各自独立的，不可预知的速度向前推进。异步性导致了结果的不可再现性。

- 结构性

  每个进程都配置一个 PCB 对其进行描述。

#### 2.1.2 进程的状态与转换

- **运行状态**

  进程正在处理机上运行。每一时刻最多只有一个进程处于运行状态

- **就绪状态**

  进程获得了除处理机外的所有资源，一旦得到处理机便可运行

- **阻塞状态 (等待状态)**

  进程等待除处理机外的其他资源

- 创建状态

- 结束状态

**状态转换**

```
创建 → 就绪 ↔ 运行 → 结束
		 ↖	 ↙
		   阻塞
```

- 就绪 ➡ 运行
- 运行 ➡ 就绪
- 运行 ➡ 阻塞
- 阻塞 ➡ 就绪

#### 2.1.3 进程控制

操作系统中把进程控制用的程序段称为 **原语**。==进程控制都是在内核的支持下完成的==

**进程创建**

- 给进程分配唯一的**进程标识号**，并申请一个空白的 PCB。==PCB 是有限的，若申请失败则创建失败==
- 为进程分配资源。==如果资源不足，不是创建失败，而是处于**阻塞状态**==
- 初始化 PCB
- 如果就绪队列能接纳新进程，把新进程插入就绪队列等待调度

**进程终止**

引起进程终止的事件有: ① 正常结束 ② 异常结束 ③ 外界干预

- 根据被终止进程的标识符，检索 PCB，从中读出该进程的状态
- 如果被终止进程处于运行状态，立刻终止，并把处理机分配给其他进程
- 如果进程还有子进程，将所有的子进程终止
- 归还该进程的资源
- 把 PCB 从所在队列 (链表) 中删除

**进程阻塞与唤醒**

进程的阻塞是自身的主动行为，只有处于运行态的进程才能转为阻塞态

- 找到要阻塞进程标识号对应的 PCB
- 如果进程处于运行状态，保护现场，将其转为阻塞态
- 把 PCB 插入相应事件的等待队列

进程的唤醒原语执行过程

- 在该事件的等待队列中找到相应进程的 PCB
- 将其从等待队列移出，并置其状态为就绪状态
- 把 PCB 插入到就绪队列中，等待调度

**进程切换**

- 保存处理机上下文，包括程序计数器和其他寄存器
- 更新 PCB 信息
- 将进程的 PCB 移动到相应的队列
- 选择另一个进程执行，并更新其 PCB
- 更新内存管理的数据结构
- 恢复处理机上下文

#### 2.1.4 进程控制块 PCB

进程控制块主要包括:

- **进程描述信息:** 进程标识符 (PID), 用户标识符 (UID)
- **进程控制和管理信息**: 进程当前状态, 进程优先级等
- **资源分配清单**
- **处理及相关信息**

#### 2.1.5 进程通信

进程通信主要有三种方式:

- **共享存储**

  操作系统负责为通信进程提供可共享使用的存储空间和同步互斥工具，数据交换由用户自己安排读/写指令完成

- **消息传递**

  使用**发送消息**和**接收消息**两个原语进行数据交换

  - 直接通信方式: 发送进程直接把消息发送给接收进程
  - 间接通信方式: 发送进程把消息发送到某个中间实体

- **管道通信**

  管道是用于连接一个读进程和一个写进程以实现他们之间通信的一个**共享文件**。管道有一些特征:
  
  - 限制大小
  - 数据一旦读取就被抛弃

#### 2.1.6 线程概念和多线程模型

**1. 线程的基本概念**

引入进程是为了提高资源利用率和吞吐量，增加并发程度。而引入线程，是为了减少切换进程的开销，提高操作系统的并发性能。线程可理解为**轻量级进程**

**2. 线程的实现方式**

线程可分为:

- **用户级线程**

  有关线程管理的所有工作都由操作系统完成，内核意识不到线程的存在

- **内核级线程**

  线程管理的所有工作由内核完成，应用程序没有线程管理的代码

用户线程和内核线程可以实现**一对一**，**一对多**，**多对多** 的映射

### 2.2 处理机调度

#### 2.2.1 调度的概念

**1. 调度的基本概念**

处理及调度是在就绪队列中，按照一定的算法 (公平、高效) 选择一个进程并将处理机分配给其运行，以实现进程并发地执行。==处理机调度是多道程序操作系统的基础，是操作系统设计的核心问题==

**2. 三级调度**

- **作业调度 (高级调度)**

  内存和外存间的调度

- **内存调度 (中级调度)**

  把暂时不能运行的进程，调至外存等待，此时进程状态为挂起

- **进程调度 (低级调度)**

  按照调度算法从就绪队列中挑选一个，将处理机分配给它

#### 2.2.2 不能调度的时机

- 处理中断的过程
- 进程在操作系统内核程序临界区
- 其他需要完全屏蔽中断的原子操作过程

#### 2.2.3 进程调度方式

- **非剥夺式调度方式**

  实现简单，系统开销小，适用于批处理系统，但不适用于分时系统和大多实时系统

- **剥夺式调度方式**

  能提高系统吞吐量和相应效率

#### 2.2.4 调度算法衡量指标

- **CPU 利用率**

- **系统吞吐量**

  单位时间内 CPU 完成作业数量

- **周转时间**

  ```latex
  周转时间 = 作业完成时间 - 作业提交时间
  带权周转时间 = 作业周转时间 / 作业实际运行时间
  ```

- **等待时间**

  衡量一个调度算法优劣，通常只需要简单地考察等待时间

- **响应时间**

  用户提交请求到系统首次产生响应的时间

- **响应比**

  ```
  响应比 = (等待时间 + 要求服务时间) / 要求服务时间
  ```

  

#### 2.2.5 典型的调度算法

- **先来先服务调度算法**
  - 算法简单，但效率低
  - 对长作业有利，短作业不利
  - 利于 CPU 繁忙型作业，不利于 I/O 繁忙型作业
- **短作业优先调度算法**
  - 对长作业不利，可能引起长作业饥饿
  - 没考虑作业的紧迫程度
  - ==平均等待时间和平均周转时间最短==
- **优先级调度算法**
  - 可分为 **非剥夺式优先级调度算法** 和 **剥夺式优先级调度算法**
  - 可使用 **静态优先级** 和 **动态优先级**
- **高响应比优先调度算法**
  - 利于短作业
  - 类先来先服务
  - 解决了饥饿
- **时间片轮转调度算法**
  - 时间片太大算法会退化为先来先服务算法。时间片太短会使得进程切换频繁，开销变大
  - 时间片长短通常由: 系统的响应时间、就绪队列中的进程数目、系统的处理能力决定
- **多级反馈队列调度算法**
  - 时间片轮转 + 优先级调度算法 + 短作业优先
  - 周转时间短
  - 不会饥饿

### 2.3 进程同步

#### 2.3.1 进程同步的基本概念

**1. 临界资源和临界区**

一次只允许一个进程使用的资源称为**临界资源**。对临界资源必须互斥地访问。访问临界资源的代码称为**临界区**。

临界资源的访问过程可分为:

- 进入区
- 临界区
- 退出区
- 剩余区

**2. 同步**

B 进程需要 A 进程执行完毕后才能执行

**3. 互斥**

A, B 同时只能有一个进程执行

**4. 准则**

- 空闲让进
- 忙则等待
- 让权等待
- 有限等待

#### 2.3.2 实现互斥的基本方法

**1. 软件实现方法**

- **单标志法**

  - 使用 `turn` 指示允许进入临界区的进程

  - 违背 **空闲让进** 原则，资源利用不充分

- **双标志先检查法**

  - 访问临界区资源前检查临界区是否正被访问
  - 可能双方同时进去临界区，违背 **忙则等待** 原则

- **双标志后检查法**

  - 先设置自己标志为 `true` 再检查对方状态标志
  - 可能双方都进入不了临界区，导致饥饿

- **皮特森算法**

  - 单标志法 + 双标志后检查法
  - 使用双标志解决互斥访问，使用单标志解决饥饿

**2. 硬件实现方法**

- **中断屏蔽**
- **硬件指令**

#### 2.3.3 信号量

**1. 基本概念**

信号量只能被两个标准的**原语 (不是系统调用是低级进程通信原语)**: `wait(S)` 和 `signal(S)` 访问。

也可以记为 `P操作（-1）` 和 `V操作(+1)`

**2. 利用信号量实现同步**

- 信号量初始值为 0 
- 前驱进程使用 V操作
- 后继进程使用 P操作

**3. 使用信号量实现互斥**

- 信号量初始值由用户指定
- 进入临界区前使用 P 操作
- 出临界区后使用 V 操作

#### 2.3.4 管程

管程组成部分:

- 局限于管程的共享数据结构
- 对管程内数据结构进行操作的一组过程
- 对管程内数据的初始化语句

#### 2.3.5 经典同步问题

-  生产者-消费者问题
- 读者-写者问题
- 哲学家进餐问题
- 吸烟者问题

### 2.4 死锁

#### 2.4.1 死锁的概念

**1. 定义**

多个进程因竞争资源导致的互相等待，若无外力作用，进程无法推进。

**2. 产生原因**

- 资源的竞争
- 进程顺序推进不当
- 信号量使用不当

死锁产生的必要条件:

- 互斥条件
- 不剥夺条件
- 请求和保持条件
- 循环等待条件

#### 2.4.2 死锁的处理策略

**1. 预防死锁**

- 破坏互斥条件

- 破坏不剥夺条件

- 破坏请求和保持条件

  一次性申请所有资源

- 破坏循环等待条件

  采用顺序资源分配法

**2. 避免死锁**

- 防止系统进入不安全状态
- 有死锁系统必然处于不安全状态，处于不安全状态不一定会发生死锁
- 可使用银行家算法避免死锁

**3. 死锁检测和解除**

**1. 资源分配图**

- 圆圈表示进程
- 框表示一类资源
- 进程到资源的边叫请求边，表示申请一单位该类资源
- 资源到进程的边叫分配边，表示该类资源有一单位被分配给了该进程

**2. 死锁定理**

当且仅当资源分配图是不可完全简化时有死锁发生

**3. 死锁解除**

- 资源剥夺

  挂起死锁进程，并剥夺它的资源

- 撤销进程

  强制撤销部分甚至所有死锁进程并剥夺资源

- 进程回退

  让一个或多个进程回退到足以避免死锁的地步